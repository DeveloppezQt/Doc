<?xml version="1.0" encoding="UTF-8"?>
<db:article xmlns:db="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.2" xml:lang="en">
<db:info>
<db:title>Custom Items Example</db:title>
<db:productname>QtDataVisualization</db:productname>
<db:edition>Qt 5.7.1 Reference Documentation</db:edition>
<db:titleabbrev>Qt Data Visualization Reference Documentation</db:titleabbrev>
<db:abstract>
<db:para>Adding custom items to a surface graph.</db:para>
<db:para>This documentation was introduced in QtDataVisualization 1.1.</db:para>
</db:abstract>
<db:pubdate>2025-06-29</db:pubdate>
<db:date>2025-06-29</db:date>
<db:authorgroup>
<db:author>
<db:orgname class="corporation">The Qt Company Ltd.</db:orgname>
</db:author>
</db:authorgroup>
</db:info>
<db:programlisting language="cpp">/****************************************************************************
**
** Copyright (C) 2016 The Qt Company Ltd.
** Contact: https://www.qt.io/licensing/
**
** This file is part of the Qt Data Visualization module of the Qt Toolkit.
**
** $QT_BEGIN_LICENSE:GPL$
** Commercial License Usage
** Licensees holding valid commercial Qt licenses may use this file in
** accordance with the commercial license agreement provided with the
** Software or, alternatively, in accordance with the terms contained in
** a written agreement between you and The Qt Company. For licensing terms
** and conditions see https://www.qt.io/terms-conditions. For further
** information use the contact form at https://www.qt.io/contact-us.
**
** GNU General Public License Usage
** Alternatively, this file may be used under the terms of the GNU
** General Public License version 3 or (at your option) any later version
** approved by the KDE Free Qt Foundation. The licenses are as published by
** the Free Software Foundation and appearing in the file LICENSE.GPL3
** included in the packaging of this file. Please review the following
** information to ensure the GNU General Public License requirements will
** be met: https://www.gnu.org/licenses/gpl-3.0.html.
**
** $QT_END_LICENSE$
**
****************************************************************************/

#include &quot;customitemgraph.h&quot;

#include &lt;QtDataVisualization/Q3DTheme&gt;
#include &lt;QtDataVisualization/QCustom3DItem&gt;
#include &lt;QtDataVisualization/QCustom3DLabel&gt;
#include &lt;QtGui/QImage&gt;

using namespace QtDataVisualization;

CustomItemGraph::CustomItemGraph(Q3DSurface *surface, QLabel *label)
    : m_graph(surface),
      m_textField(label),
      m_previouslyAnimatedItem(0)
{
    QImage layerOneHMap(&quot;:/maps/layer_1.png&quot;);
    QHeightMapSurfaceDataProxy *layerOneProxy = new QHeightMapSurfaceDataProxy(layerOneHMap);
    QSurface3DSeries *layerOneSeries = new QSurface3DSeries(layerOneProxy);
    layerOneSeries-&gt;setItemLabelFormat(QStringLiteral(&quot;(@xLabel, @zLabel): @yLabel&quot;));
    layerOneProxy-&gt;setValueRanges(34.0f, 40.0f, 18.0f, 24.0f);
    layerOneSeries-&gt;setDrawMode(QSurface3DSeries::DrawSurface);
    layerOneSeries-&gt;setFlatShadingEnabled(false);

    QImage layerTwoHMap(&quot;:/maps/layer_2.png&quot;);
    QHeightMapSurfaceDataProxy *layerTwoProxy = new QHeightMapSurfaceDataProxy(layerTwoHMap);
    QSurface3DSeries *layerTwoSeries = new QSurface3DSeries(layerTwoProxy);
    layerTwoSeries-&gt;setItemLabelFormat(QStringLiteral(&quot;(@xLabel, @zLabel): @yLabel&quot;));
    layerTwoProxy-&gt;setValueRanges(34.0f, 40.0f, 18.0f, 24.0f);
    layerTwoSeries-&gt;setDrawMode(QSurface3DSeries::DrawSurface);
    layerTwoSeries-&gt;setFlatShadingEnabled(false);

    QImage layerThreeHMap(&quot;:/maps/layer_3.png&quot;);
    QHeightMapSurfaceDataProxy *layerThreeProxy = new QHeightMapSurfaceDataProxy(layerThreeHMap);
    QSurface3DSeries *layerThreeSeries = new QSurface3DSeries(layerThreeProxy);
    layerThreeSeries-&gt;setItemLabelFormat(QStringLiteral(&quot;(@xLabel, @zLabel): @yLabel&quot;));
    layerThreeProxy-&gt;setValueRanges(34.0f, 40.0f, 18.0f, 24.0f);
    layerThreeSeries-&gt;setDrawMode(QSurface3DSeries::DrawSurface);
    layerThreeSeries-&gt;setFlatShadingEnabled(false);

    m_graph-&gt;axisX()-&gt;setLabelFormat(&quot;%.1f N&quot;);
    m_graph-&gt;axisZ()-&gt;setLabelFormat(&quot;%.1f E&quot;);
    m_graph-&gt;axisX()-&gt;setRange(34.0f, 40.0f);
    m_graph-&gt;axisY()-&gt;setRange(0.0f, 200.0f);
    m_graph-&gt;axisZ()-&gt;setRange(18.0f, 24.0f);

    m_graph-&gt;axisX()-&gt;setTitle(QStringLiteral(&quot;Latitude&quot;));
    m_graph-&gt;axisY()-&gt;setTitle(QStringLiteral(&quot;Height&quot;));
    m_graph-&gt;axisZ()-&gt;setTitle(QStringLiteral(&quot;Longitude&quot;));

    m_graph-&gt;addSeries(layerOneSeries);
    m_graph-&gt;addSeries(layerTwoSeries);
    m_graph-&gt;addSeries(layerThreeSeries);

    QLinearGradient grOne;
    grOne.setColorAt(0.0, Qt::black);
    grOne.setColorAt(0.38, Qt::darkYellow);
    grOne.setColorAt(0.39, Qt::darkGreen);
    grOne.setColorAt(0.5, Qt::darkGray);
    grOne.setColorAt(1.0, Qt::gray);
    m_graph-&gt;seriesList().at(0)-&gt;setBaseGradient(grOne);
    m_graph-&gt;seriesList().at(0)-&gt;setColorStyle(Q3DTheme::ColorStyleRangeGradient);

    QLinearGradient grTwo;
    grTwo.setColorAt(0.385, Qt::blue);
    grTwo.setColorAt(0.395, Qt::white);
    m_graph-&gt;seriesList().at(1)-&gt;setBaseGradient(grTwo);
    m_graph-&gt;seriesList().at(1)-&gt;setColorStyle(Q3DTheme::ColorStyleRangeGradient);

    QLinearGradient grThree;
    grThree.setColorAt(0.0, Qt::white);
    grThree.setColorAt(0.05, Qt::black);
    m_graph-&gt;seriesList().at(2)-&gt;setBaseGradient(grThree);
    m_graph-&gt;seriesList().at(2)-&gt;setColorStyle(Q3DTheme::ColorStyleRangeGradient);

    m_graph-&gt;scene()-&gt;activeCamera()-&gt;setCameraPreset(Q3DCamera::CameraPresetFront);

    connect(m_graph, &amp;QAbstract3DGraph::selectedElementChanged,
            this, &amp;CustomItemGraph::handleElementSelected);

    m_selectionAnimation = new QPropertyAnimation(this);
    m_selectionAnimation-&gt;setPropertyName(&quot;scaling&quot;);
    m_selectionAnimation-&gt;setDuration(500);
    m_selectionAnimation-&gt;setLoopCount(-1);

    QFont titleFont = QFont(&quot;Century Gothic&quot;, 30);
    titleFont.setBold(true);
    QCustom3DLabel *titleLabel = new QCustom3DLabel(&quot;Oil Rigs on Imaginary Sea&quot;, titleFont,
                                                    QVector3D(0.0f, 1.2f, 0.0f),
                                                    QVector3D(1.0f, 1.0f, 0.0f),
                                                    QQuaternion());
    titleLabel-&gt;setPositionAbsolute(true);
    titleLabel-&gt;setFacingCamera(true);
    titleLabel-&gt;setBackgroundColor(QColor(0x66cdaa));
    m_graph-&gt;addCustomItem(titleLabel);

    toggleItemOne(true);
    toggleItemTwo(true);
}

CustomItemGraph::~CustomItemGraph()
{
    delete m_graph;
}

void CustomItemGraph::toggleItemOne(bool show)
{
    QVector3D positionOne = QVector3D(39.0f, 77.0f, 19.2f);
    QVector3D positionOnePipe = QVector3D(39.0f, 45.0f, 19.2f);
    QVector3D positionOneLabel = QVector3D(39.0f, 107.0f, 19.2f);
    if (show) {
        QImage color = QImage(2, 2, QImage::Format_RGB32);
        color.fill(Qt::red);
        QCustom3DItem *item = new QCustom3DItem(&quot;:/items/oilrig.obj&quot;, positionOne,
                                                QVector3D(0.025f, 0.025f, 0.025f),
                                                QQuaternion::fromAxisAndAngle(0.0f, 1.0f, 0.0f, 45.0f),
                                                color);
        m_graph-&gt;addCustomItem(item);
        item = new QCustom3DItem(&quot;:/items/pipe.obj&quot;, positionOnePipe,
                                 QVector3D(0.005f, 0.5f, 0.005f),
                                 QQuaternion(),
                                 color);
        item-&gt;setShadowCasting(false);
        m_graph-&gt;addCustomItem(item);

        QCustom3DLabel *label = new QCustom3DLabel();
        label-&gt;setText(&quot;Oil Rig One&quot;);
        label-&gt;setPosition(positionOneLabel);
        label-&gt;setScaling(QVector3D(1.0f, 1.0f, 1.0f));
        m_graph-&gt;addCustomItem(label);
    } else {
        resetSelection();
        m_graph-&gt;removeCustomItemAt(positionOne);
        m_graph-&gt;removeCustomItemAt(positionOnePipe);
        m_graph-&gt;removeCustomItemAt(positionOneLabel);
    }
}

void CustomItemGraph::toggleItemTwo(bool show)
{
    QVector3D positionTwo = QVector3D(34.5f, 77.0f, 23.4f);
    QVector3D positionTwoPipe = QVector3D(34.5f, 45.0f, 23.4f);
    QVector3D positionTwoLabel = QVector3D(34.5f, 107.0f, 23.4f);
    if (show) {
        QImage color = QImage(2, 2, QImage::Format_RGB32);
        color.fill(Qt::red);
        QCustom3DItem *item = new QCustom3DItem();
        item-&gt;setMeshFile(&quot;:/items/oilrig.obj&quot;);
        item-&gt;setPosition(positionTwo);
        item-&gt;setScaling(QVector3D(0.025f, 0.025f, 0.025f));
        item-&gt;setRotation(QQuaternion::fromAxisAndAngle(0.0f, 1.0f, 0.0f, 25.0f));
        item-&gt;setTextureImage(color);
        m_graph-&gt;addCustomItem(item);
        item = new QCustom3DItem(&quot;:/items/pipe.obj&quot;, positionTwoPipe,
                                 QVector3D(0.005f, 0.5f, 0.005f),
                                 QQuaternion(),
                                 color);
        item-&gt;setShadowCasting(false);
        m_graph-&gt;addCustomItem(item);

        QCustom3DLabel *label = new QCustom3DLabel();
        label-&gt;setText(&quot;Oil Rig Two&quot;);
        label-&gt;setPosition(positionTwoLabel);
        label-&gt;setScaling(QVector3D(1.0f, 1.0f, 1.0f));
        m_graph-&gt;addCustomItem(label);
    } else {
        resetSelection();
        m_graph-&gt;removeCustomItemAt(positionTwo);
        m_graph-&gt;removeCustomItemAt(positionTwoPipe);
        m_graph-&gt;removeCustomItemAt(positionTwoLabel);
    }
}

void CustomItemGraph::toggleItemThree(bool show)
{
    QVector3D positionThree = QVector3D(34.5f, 86.0f, 19.1f);
    QVector3D positionThreeLabel = QVector3D(34.5f, 116.0f, 19.1f);
    if (show) {
        QImage color = QImage(2, 2, QImage::Format_RGB32);
        color.fill(Qt::darkMagenta);
        QCustom3DItem *item = new QCustom3DItem();
        item-&gt;setMeshFile(&quot;:/items/refinery.obj&quot;);
        item-&gt;setPosition(positionThree);
        item-&gt;setScaling(QVector3D(0.04f, 0.04f, 0.04f));
        item-&gt;setRotation(QQuaternion::fromAxisAndAngle(0.0f, 1.0f, 0.0f, 75.0f));
        item-&gt;setTextureImage(color);
        m_graph-&gt;addCustomItem(item);

        QCustom3DLabel *label = new QCustom3DLabel();
        label-&gt;setText(&quot;Refinery&quot;);
        label-&gt;setPosition(positionThreeLabel);
        label-&gt;setScaling(QVector3D(1.0f, 1.0f, 1.0f));
        m_graph-&gt;addCustomItem(label);
    } else {
        resetSelection();
        m_graph-&gt;removeCustomItemAt(positionThree);
        m_graph-&gt;removeCustomItemAt(positionThreeLabel);
    }
}

void CustomItemGraph::toggleSeeThrough(bool seethrough)
{
    if (seethrough) {
        m_graph-&gt;seriesList().at(0)-&gt;setDrawMode(QSurface3DSeries::DrawWireframe);
        m_graph-&gt;seriesList().at(1)-&gt;setDrawMode(QSurface3DSeries::DrawWireframe);
    } else {
        m_graph-&gt;seriesList().at(0)-&gt;setDrawMode(QSurface3DSeries::DrawSurface);
        m_graph-&gt;seriesList().at(1)-&gt;setDrawMode(QSurface3DSeries::DrawSurface);
    }
}

void CustomItemGraph::toggleOilHighlight(bool highlight)
{
    if (highlight) {
        QLinearGradient grThree;
        grThree.setColorAt(0.0, Qt::black);
        grThree.setColorAt(0.05, Qt::red);
        m_graph-&gt;seriesList().at(2)-&gt;setBaseGradient(grThree);
    } else {
        QLinearGradient grThree;
        grThree.setColorAt(0.0, Qt::white);
        grThree.setColorAt(0.05, Qt::black);
        m_graph-&gt;seriesList().at(2)-&gt;setBaseGradient(grThree);
    }
}

void CustomItemGraph::toggleShadows(bool shadows)
{
    if (shadows)
        m_graph-&gt;setShadowQuality(QAbstract3DGraph::ShadowQualityMedium);
    else
        m_graph-&gt;setShadowQuality(QAbstract3DGraph::ShadowQualityNone);
}

void CustomItemGraph::handleElementSelected(QAbstract3DGraph::ElementType type)
{
    resetSelection();
    if (type == QAbstract3DGraph::ElementCustomItem) {
        QCustom3DItem *item = m_graph-&gt;selectedCustomItem();
        QString text;
        if (qobject_cast&lt;QCustom3DLabel *&gt;(item) != 0) {
            text.append(&quot;Custom label: &quot;);
        } else {
            QStringList split = item-&gt;meshFile().split(&quot;/&quot;);
            text.append(split.last());
            text.append(&quot;: &quot;);
        }
        int index = m_graph-&gt;selectedCustomItemIndex();
        text.append(QString::number(index));
        m_textField-&gt;setText(text);
        m_previouslyAnimatedItem = item;
        m_previousScaling = item-&gt;scaling();
        m_selectionAnimation-&gt;setTargetObject(item);
        m_selectionAnimation-&gt;setStartValue(item-&gt;scaling());
        m_selectionAnimation-&gt;setEndValue(item-&gt;scaling() * 1.5f);
        m_selectionAnimation-&gt;start();
    } else if (type == QAbstract3DGraph::ElementSeries) {
        QString text = &quot;Surface (&quot;;
        QSurface3DSeries *series = m_graph-&gt;selectedSeries();
        if (series) {
            QPoint point = series-&gt;selectedPoint();
            QString posStr;
            posStr.setNum(point.x());
            text.append(posStr);
            text.append(&quot;, &quot;);
            posStr.setNum(point.y());
            text.append(posStr);
        }
        text.append(&quot;)&quot;);
        m_textField-&gt;setText(text);
    } else if (type &gt; QAbstract3DGraph::ElementSeries
               &amp;&amp; type &lt; QAbstract3DGraph::ElementCustomItem) {
        int index = m_graph-&gt;selectedLabelIndex();
        QString text;
        if (type == QAbstract3DGraph::ElementAxisXLabel)
            text.append(&quot;Axis X label: &quot;);
        else if (type == QAbstract3DGraph::ElementAxisYLabel)
            text.append(&quot;Axis Y label: &quot;);
        else
            text.append(&quot;Axis Z label: &quot;);
        text.append(QString::number(index));
        m_textField-&gt;setText(text);
    } else {
        m_textField-&gt;setText(&quot;Nothing&quot;);
    }
}

void CustomItemGraph::resetSelection()
{
    m_selectionAnimation-&gt;stop();
    if (m_previouslyAnimatedItem)
        m_previouslyAnimatedItem-&gt;setScaling(m_previousScaling);
    m_previouslyAnimatedItem = 0;
}

</db:programlisting>
</db:article>
