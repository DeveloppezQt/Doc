<?xml version="1.0" encoding="UTF-8"?>
<db:article xmlns:db="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.2" xml:lang="en">
<db:info>
<db:title>Image Composition Example</db:title>
<db:productname>QtWidgets</db:productname>
<db:edition>Qt 5.13.2 Reference Documentation</db:edition>
<db:titleabbrev>Qt Widgets Reference Documentation</db:titleabbrev>
<db:abstract>
<db:para>Shows how composition modes work in QPainter.</db:para>
</db:abstract>
<db:pubdate>2024-12-27</db:pubdate>
<db:date>2024-12-27</db:date>
<db:authorgroup>
<db:author>
<db:orgname class="corporation">The Qt Company Ltd.</db:orgname>
</db:author>
</db:authorgroup>
</db:info>
<db:mediaobject>
<db:imageobject>
<db:imagedata fileref="images/imagecomposition-example.png"/>
</db:imageobject>
</db:mediaobject>
<db:section xml:id="setting-up-the-resource-file">
<db:title>Setting Up The Resource File</db:title>
<db:para>The Image Composition example requires two source images, <db:emphasis>butterfly.png</db:emphasis> and <db:emphasis>checker.png</db:emphasis> that are embedded within <db:emphasis>imagecomposition.qrc</db:emphasis>. The file contains the following code:</db:para>
<db:programlisting language="cpp">&amp;lt;!DOCTYPE RCC&amp;gt;&amp;lt;RCC version=&quot;1.0&quot;&amp;gt;
&amp;lt;qresource&amp;gt;
    &amp;lt;file&amp;gt;images/butterfly.png&amp;lt;/file&amp;gt;
    &amp;lt;file&amp;gt;images/checker.png&amp;lt;/file&amp;gt;
&amp;lt;/qresource&amp;gt;
&amp;lt;/RCC&amp;gt;
</db:programlisting>
<db:para>For more information on resource files, see <db:link xlink:href="resources.xml">The Qt Resource System</db:link>.</db:para>
</db:section>
<db:section xml:id="imagecomposer-class-definition">
<db:title>ImageComposer Class Definition</db:title>
<db:para>The <db:code>ImageComposer</db:code> class is a subclass of QWidget that implements three private slots, <db:code>chooseSource()</db:code>, <db:code>chooseDestination()</db:code>, and <db:code>recalculateResult()</db:code>.</db:para>
<db:programlisting language="cpp">class ImageComposer : public QWidget
{
    Q_OBJECT

public:
    ImageComposer();

private slots:
    void chooseSource();
    void chooseDestination();
    void recalculateResult();
</db:programlisting>
<db:para>In addition, <db:code>ImageComposer</db:code> consists of five private functions, <db:code>addOp()</db:code>, <db:code>chooseImage()</db:code>, <db:code>loadImage()</db:code>, <db:code>currentMode()</db:code>, and <db:code>imagePos()</db:code>, as well as private instances of QToolButton, QComboBox, QLabel, and QImage.</db:para>
<db:programlisting language="cpp">private:
    void addOp(QPainter::CompositionMode mode, const QString &amp;amp;name);
    void chooseImage(const QString &amp;amp;title, QImage *image, QToolButton *button);
    void loadImage(const QString &amp;amp;fileName, QImage *image, QToolButton *button);
    QPainter::CompositionMode currentMode() const;
    QPoint imagePos(const QImage &amp;amp;image) const;

    QToolButton *sourceButton;
    QToolButton *destinationButton;
    QComboBox *operatorComboBox;
    QLabel *equalLabel;
    QLabel *resultLabel;

    QImage sourceImage;
    QImage destinationImage;
    QImage resultImage;
};
</db:programlisting>
</db:section>
<db:section xml:id="imagecomposer-class-implementation">
<db:title>ImageComposer Class Implementation</db:title>
<db:para>We declare a QSize object, <db:code>resultSize</db:code>, as a static constant with width and height equal to 200.</db:para>
<db:programlisting language="cpp">static const QSize resultSize(200, 200);
</db:programlisting>
<db:para>Within the constructor, we instantiate a QToolButton object, <db:code>sourceButton</db:code> and set its iconSize property to <db:code>resultSize</db:code>. The <db:code>operatorComboBox</db:code> is instantiated and then populated using the <db:code>addOp()</db:code> function. This function accepts a QPainter::CompositionMode, <db:code role="parameter">mode</db:code>, and a QString, <db:code role="parameter">name</db:code>, representing the name of the composition mode.</db:para>
<db:programlisting language="cpp">ImageComposer::ImageComposer()
{
    sourceButton = new QToolButton;
    sourceButton-&amp;gt;setIconSize(resultSize);

    operatorComboBox = new QComboBox;
    addOp(QPainter::CompositionMode_SourceOver, tr(&quot;SourceOver&quot;));
    addOp(QPainter::CompositionMode_DestinationOver, tr(&quot;DestinationOver&quot;));
    addOp(QPainter::CompositionMode_Clear, tr(&quot;Clear&quot;));
    addOp(QPainter::CompositionMode_Source, tr(&quot;Source&quot;));
    addOp(QPainter::CompositionMode_Destination, tr(&quot;Destination&quot;));
    addOp(QPainter::CompositionMode_SourceIn, tr(&quot;SourceIn&quot;));
    addOp(QPainter::CompositionMode_DestinationIn, tr(&quot;DestinationIn&quot;));
    addOp(QPainter::CompositionMode_SourceOut, tr(&quot;SourceOut&quot;));
    addOp(QPainter::CompositionMode_DestinationOut, tr(&quot;DestinationOut&quot;));
    addOp(QPainter::CompositionMode_SourceAtop, tr(&quot;SourceAtop&quot;));
    addOp(QPainter::CompositionMode_DestinationAtop, tr(&quot;DestinationAtop&quot;));
    addOp(QPainter::CompositionMode_Xor, tr(&quot;Xor&quot;));
    addOp(QPainter::CompositionMode_Plus, tr(&quot;Plus&quot;));
    addOp(QPainter::CompositionMode_Multiply, tr(&quot;Multiply&quot;));
    addOp(QPainter::CompositionMode_Screen, tr(&quot;Screen&quot;));
    addOp(QPainter::CompositionMode_Overlay, tr(&quot;Overlay&quot;));
    addOp(QPainter::CompositionMode_Darken, tr(&quot;Darken&quot;));
    addOp(QPainter::CompositionMode_Lighten, tr(&quot;Lighten&quot;));
    addOp(QPainter::CompositionMode_ColorDodge, tr(&quot;ColorDodge&quot;));
    addOp(QPainter::CompositionMode_ColorBurn, tr(&quot;ColorBurn&quot;));
    addOp(QPainter::CompositionMode_HardLight, tr(&quot;HardLight&quot;));
    addOp(QPainter::CompositionMode_SoftLight, tr(&quot;SoftLight&quot;));
    addOp(QPainter::CompositionMode_Difference, tr(&quot;Difference&quot;));
    addOp(QPainter::CompositionMode_Exclusion, tr(&quot;Exclusion&quot;));
</db:programlisting>
<db:para>The <db:code>destinationButton</db:code> is instantiated and its iconSize property is set to <db:code>resultSize</db:code> as well. The QLabels <db:code>equalLabel</db:code> and <db:code>resultLabel</db:code> are created and <db:code>resultLabel</db:code>'s minimumWidth is set.</db:para>
<db:programlisting language="cpp">    destinationButton = new QToolButton;
    destinationButton-&amp;gt;setIconSize(resultSize);

    equalLabel = new QLabel(tr(&quot;=&quot;));

    resultLabel = new QLabel;
    resultLabel-&amp;gt;setMinimumWidth(resultSize.width());
</db:programlisting>
<db:para>We connect the following signals to their corresponding slots:</db:para>
<db:itemizedlist>
<db:listitem>
<db:para><db:code>sourceButton</db:code>'s <db:link xlink:href="">clicked()</db:link> signal is connected to <db:code>chooseSource()</db:code>,</db:para>
</db:listitem>
<db:listitem>
<db:para><db:code>operatorComboBox</db:code>'s <db:link xlink:href="">activated()</db:link> signal is connected to <db:code>recalculateResult()</db:code>, and</db:para>
</db:listitem>
<db:listitem>
<db:para><db:code>destinationButton</db:code>'s <db:link xlink:href="">clicked()</db:link> signal is connected to <db:code>chooseDestination()</db:code>.</db:para>
</db:listitem>
</db:itemizedlist>
<db:programlisting language="cpp">    connect(sourceButton, &amp;amp;QAbstractButton::clicked,
            this, &amp;amp;ImageComposer::chooseSource);
    connect(operatorComboBox, QOverload&amp;lt;int&amp;gt;::of(&amp;amp;QComboBox::activated),
            this, &amp;amp;ImageComposer::recalculateResult);
    connect(destinationButton, &amp;amp;QAbstractButton::clicked,
            this, &amp;amp;ImageComposer::chooseDestination);
</db:programlisting>
<db:para>A QGridLayout, <db:code>mainLayout</db:code>, is used to place all the widgets. Note that <db:code>mainLayout</db:code>'s sizeConstraint property is set to QLayout::SetFixedSize, which means that <db:code>ImageComposer</db:code>'s size cannot be resized at all.</db:para>
<db:programlisting language="cpp">    QGridLayout *mainLayout = new QGridLayout;
    mainLayout-&amp;gt;addWidget(sourceButton, 0, 0, 3, 1);
    mainLayout-&amp;gt;addWidget(operatorComboBox, 1, 1);
    mainLayout-&amp;gt;addWidget(destinationButton, 0, 2, 3, 1);
    mainLayout-&amp;gt;addWidget(equalLabel, 1, 3);
    mainLayout-&amp;gt;addWidget(resultLabel, 0, 4, 3, 1);
    mainLayout-&amp;gt;setSizeConstraint(QLayout::SetFixedSize);
    setLayout(mainLayout);
</db:programlisting>
<db:para>We create a QImage, <db:code>resultImage</db:code>, and we invoke <db:code>loadImage()</db:code> twice to load both the image files in our <db:emphasis>imagecomposition.qrc</db:emphasis> file. Then, we set the windowTitle property to &quot;Image Composition&quot;.</db:para>
<db:programlisting language="cpp">    resultImage = QImage(resultSize, QImage::Format_ARGB32_Premultiplied);

    loadImage(&quot;:/images/butterfly.png&quot;, &amp;amp;sourceImage, sourceButton);
    loadImage(&quot;:/images/checker.png&quot;, &amp;amp;destinationImage, destinationButton);

    setWindowTitle(tr(&quot;Image Composition&quot;));
}
</db:programlisting>
<db:para>The <db:code>chooseSource()</db:code> and <db:code>chooseDestination()</db:code> functions are convenience functions that invoke <db:code>chooseImage()</db:code> with specific parameters.</db:para>
<db:programlisting language="cpp">void ImageComposer::chooseSource()
{
    chooseImage(tr(&quot;Choose Source Image&quot;), &amp;amp;sourceImage, sourceButton);
}

void ImageComposer::chooseDestination()
{
    chooseImage(tr(&quot;Choose Destination Image&quot;), &amp;amp;destinationImage, destinationButton);
}
</db:programlisting>
<db:para>The <db:code>chooseImage()</db:code> function loads an image of the user's choice, depending on the <db:code role="parameter">title</db:code>, <db:code role="parameter">image</db:code>, and <db:code role="parameter">button</db:code>.</db:para>
<db:programlisting language="cpp">void ImageComposer::chooseImage(const QString &amp;amp;title, QImage *image,
                                QToolButton *button)
{
    QString fileName = QFileDialog::getOpenFileName(this, title);
    if (!fileName.isEmpty())
        loadImage(fileName, image, button);
}
</db:programlisting>
<db:para>The <db:code>recalculateResult()</db:code> function is used to calculate amd display the result of combining the two images together with the user's choice of composition mode.</db:para>
<db:programlisting language="cpp">void ImageComposer::recalculateResult()
{
    QPainter::CompositionMode mode = currentMode();

    QPainter painter(&amp;amp;resultImage);
    painter.setCompositionMode(QPainter::CompositionMode_Source);
    painter.fillRect(resultImage.rect(), Qt::transparent);
    painter.setCompositionMode(QPainter::CompositionMode_SourceOver);
    painter.drawImage(0, 0, destinationImage);
    painter.setCompositionMode(mode);
    painter.drawImage(0, 0, sourceImage);
    painter.setCompositionMode(QPainter::CompositionMode_DestinationOver);
    painter.fillRect(resultImage.rect(), Qt::white);
    painter.end();

    resultLabel-&amp;gt;setPixmap(QPixmap::fromImage(resultImage));
}
</db:programlisting>
<db:para>The <db:code>addOp()</db:code> function adds an item to the <db:code>operatorComboBox</db:code> using QComboBox's addItem function. This function accepts a QPainter::CompositionMode, <db:code role="parameter">mode</db:code>, and a QString, <db:code role="parameter">name</db:code>. The rectangle is filled with Qt::Transparent and both the <db:code>sourceImage</db:code> and <db:code>destinationImage</db:code> are painted, before displaying it on <db:code>resultLabel</db:code>.</db:para>
<db:programlisting language="cpp">void ImageComposer::addOp(QPainter::CompositionMode mode, const QString &amp;amp;name)
{
    operatorComboBox-&amp;gt;addItem(name, mode);
}
</db:programlisting>
<db:para>The <db:code>loadImage()</db:code> function paints a transparent background using <db:link xlink:href="">fillRect()</db:link> and draws <db:code>image</db:code> in a centralized position using <db:link xlink:href="">drawImage()</db:link>. This <db:code>image</db:code> is then set as the <db:code>button</db:code>'s icon.</db:para>
<db:programlisting language="cpp">void ImageComposer::loadImage(const QString &amp;amp;fileName, QImage *image,
                              QToolButton *button)
{
    image-&amp;gt;load(fileName);

    // Scale the image to given size
    *image = image-&amp;gt;scaled(resultSize, Qt::KeepAspectRatio);

    QImage fixedImage(resultSize, QImage::Format_ARGB32_Premultiplied);
    QPainter painter(&amp;amp;fixedImage);
    painter.setCompositionMode(QPainter::CompositionMode_Source);
    painter.fillRect(fixedImage.rect(), Qt::transparent);
    painter.setCompositionMode(QPainter::CompositionMode_SourceOver);
    painter.drawImage(imagePos(*image), *image);
    painter.end();
    button-&amp;gt;setIcon(QPixmap::fromImage(fixedImage));

    *image = fixedImage;

    recalculateResult();
}
</db:programlisting>
<db:para>The <db:code>currentMode()</db:code> function returns the composition mode currently selected in <db:code>operatorComboBox</db:code>.</db:para>
<db:programlisting language="cpp">QPainter::CompositionMode ImageComposer::currentMode() const
{
    return (QPainter::CompositionMode)
           operatorComboBox-&amp;gt;itemData(operatorComboBox-&amp;gt;currentIndex()).toInt();
}
</db:programlisting>
<db:para>We use the <db:code>imagePos()</db:code> function to ensure that images loaded onto the QToolButton objects, <db:code>sourceButton</db:code> and <db:code>destinationButton</db:code>, are centralized.</db:para>
<db:programlisting language="cpp">QPoint ImageComposer::imagePos(const QImage &amp;amp;image) const
{
    return QPoint((resultSize.width() - image.width()) / 2,
                  (resultSize.height() - image.height()) / 2);
}
</db:programlisting>
</db:section>
<db:section xml:id="the-main-function">
<db:title>The <db:code>main()</db:code> Function</db:title>
<db:para>The <db:code>main()</db:code> function instantiates QApplication and <db:code>ImageComposer</db:code> and invokes its <db:link xlink:href="">show()</db:link> function.</db:para>
<db:programlisting language="cpp">int main(int argc, char *argv[])
{
    Q_INIT_RESOURCE(imagecomposition);

    QApplication app(argc, argv);
    ImageComposer composer;
    composer.show();
    return app.exec();
}
</db:programlisting>
</db:section>
<db:section>
<db:title>Example project</db:title>
<db:para><db:link xlink:href="https://code.qt.io/cgit/qt/qtbase.git/tree/examples/widgets/painting/imagecomposition?h=5.13">Example project @ code.qt.io</db:link></db:para>
</db:section>
</db:article>
